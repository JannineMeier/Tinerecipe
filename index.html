<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Rezepte ‚Ä¢ Produkte ‚Ä¢ Einkaufskorb</title>

<!-- PWA / iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#ff74b8">

<style>
  :root{
    --bg-1:#ffeef6; --bg-2:#fff6fb; --card:#fff;
    --text:#2f2330; --muted:#7f6576; --border:#f3d7e6;
    --pink:#ff74b8; --pink-2:#ff9ad1; --cart:#ff9a1e;
    --radius:18px; --shadow:0 8px 24px rgba(175,78,129,.15);
    --pad:14px; --focus:0 0 0 3px rgba(255,116,184,.25);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100% } body{
    margin:0;
    background:
      radial-gradient(1000px 700px at 15% -10%, var(--bg-2), transparent 60%),
      radial-gradient(900px 600px at 110% 0%, #ffe3f1, transparent 55%),
      var(--bg-1);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color:var(--text);
  }

  header{ position:sticky; top:0; z-index:30; backdrop-filter:blur(8px);
    background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6));
    border-bottom:1px solid var(--border);}
  .container{ max-width:1000px; margin:0 auto; padding:12px 16px;}
  .title-row{ display:flex; align-items:center; gap:10px;}
  .logo{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
    background:#ffd3ea; color:#7c2a59; font-weight:900; box-shadow:0 6px 18px rgba(255,105,180,.25);}
  h1{ margin:0; font-size:18px; letter-spacing:.3px}

  .tabs{ display:flex; gap:10px; margin-top:10px;}
  .tab{ flex:1; padding:12px; border-radius:12px; border:1px solid var(--border);
    background:#fff; color:var(--text); cursor:pointer; transition:.15s; box-shadow:var(--shadow); font-weight:700;}
  .tab:hover{ transform:translateY(-1px)}
  .tab.active[data-tab="recipes"]{ border-color:var(--pink); color:var(--pink);}
  .tab.active[data-tab="products"]{ border-color:#ffb0df; color:#d9489a;}
  .tab.active[data-tab="cart"]{ border-color:var(--cart); color:#b25c00;}

  main{ max-width:1000px; margin:16px auto; padding:0 16px 120px;}
  .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
    padding:var(--pad); box-shadow:var(--shadow); margin-bottom:12px;}
  .section-title{ font-weight:800; margin:4px 0 8px;}
  .muted{ color:var(--muted) }
  .grid{ display:grid; gap:12px } @media (min-width:760px){ .grid-2{ grid-template-columns:1fr 1fr } }
  .row{ display:grid; gap:10px } .row-2{ grid-template-columns:1fr 1fr }

  /* Buttons */
  .btn{ appearance:none; border:1px solid var(--border); border-radius:12px; background:#fff;
    color:var(--text); padding:12px 14px; cursor:pointer; transition:.15s;
    box-shadow:0 6px 16px rgba(175,78,129,.12); font-weight:700; line-height:1; }
  .btn:focus-visible{ outline:none; box-shadow:var(--focus) }
  .btn:hover{ transform:translateY(-1px)}
  .btn.pink{ border-color:var(--pink); color:#fff; background:var(--pink);}
  .btn.pink-ghost{ background:#fff; border-color:var(--pink-2); color:#b0307d;}
  .btn.orange{ border-color:var(--cart); color:#7c2a00; background:#ffd39a;}
  .btn.neutral{ background:#fff; border-color:var(--border); color:var(--text);}
  .btn.small{ padding:10px 12px; border-radius:10px; font-size:14px}
  .btn.icon{ width:40px; height:40px; display:grid; place-items:center; padding:0;}
  .btn.icon.small{ width:34px; height:34px;}

  /* Inputs */
  input[type="text"], input[type="url"], input[type="search"], input[type="number"], textarea, select{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--border);
    background:#fff; color:var(--text); outline:none; font-size:16px;}
  input:focus, textarea:focus, select:focus{ box-shadow:var(--focus); border-color:var(--pink-2) }
  textarea{ min-height:100px }
  datalist option{ font-size:16px; } /* iOS */

  .pill{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); background:#fff }
  .checkline{ display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px dashed var(--border) }
  .right{ margin-left:auto }

  .accent.recipes{ border-left:4px solid var(--pink); padding-left:10px; background:#fff0f7 }
  .accent.products{ border-left:4px solid #ffb0df; padding-left:10px; background:#fff4fb }
  .accent.cart{ border-left:4px solid var(--cart); padding-left:10px; background:#fff6e6 }

  details.collapsible{ border:1px dashed var(--border); border-radius:16px; overflow:hidden; background:#fff }
  details.collapsible[open] summary{ border-bottom:1px dashed var(--border) }
  summary{ list-style:none; cursor:pointer; padding:10px 12px; display:flex; align-items:center; gap:10px; }
  summary::-webkit-details-marker{ display:none }
  .chev{ transition:.15s } details[open] .chev{ transform:rotate(90deg) }

  .tag-group{ margin:6px 0 4px } .tag-group h4{ margin:6px 0 4px; font-size:13px; color:var(--muted); font-weight:800 }
  .chips{ display:flex; flex-wrap:wrap; gap:8px }
  .chip{ padding:6px 10px; border-radius:999px; border:1px solid #ffc1df; background:#fff; color:#2f2330; font-size:12px; cursor:pointer }
  .chip.active{ background:#ffe0f0; border-color:var(--pink); color:#b0307d }
  .chip.small{ padding:4px 8px; font-size:11px } .tags-inline{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }

  .img-glow{ box-shadow:0 10px 24px rgba(255,105,180,.12); border:1px solid var(--border); border-radius:14px }
  .qty{ display:flex; align-items:center; gap:6px } .qty input{ width:120px; }
  .info{ font-size:12px; color:var(--muted) }

  /* Modal (Add-ons Auswahl) */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; z-index:1000;
  }
  .modal{ background:#fff; border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); max-width:520px; width:92%; padding:16px; }
  .modal h3{ margin:0 0 6px; }
  .modal .list{ max-height:50vh; overflow:auto; margin:8px 0 12px; border:1px dashed var(--border); border-radius:12px; padding:8px; }
  .modal .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
</style>

<script>
/* ---- iOS Kompat-Patches ---- */
(function(){
  if (!window.crypto) window.crypto = {};
  if (!crypto.randomUUID) {
    crypto.randomUUID = function(){
      const s = () => Math.random().toString(16).slice(2, 10);
      return `id-${Date.now().toString(16)}-${s()}-${s()}`;
    };
  }
})();
const SUPPORTS_DETAILS = 'open' in document.createElement('details');
</script>

<script>
/* PWA-Icons on-the-fly */
(function(){
  function makeIcon(size, letter='R'){
    const c=document.createElement('canvas'); c.width=size; c.height=size;
    const g=c.getContext('2d'); g.fillStyle='#ff9ad1'; g.fillRect(0,0,size,size);
    g.fillStyle='#fff'; g.font=`${Math.floor(size*0.55)}px 900 system-ui, -apple-system, Segoe UI, Arial`;
    g.textAlign='center'; g.textBaseline='middle'; g.shadowColor='rgba(0,0,0,.12)'; g.shadowBlur=6;
    g.fillText(letter,size/2,size/2+size*0.04); return c.toDataURL('image/png');
  }
  const icon192=makeIcon(192,'R'), icon512=makeIcon(512,'R');
  const l=document.createElement('link'); l.rel='apple-touch-icon'; l.href=icon192; document.head.appendChild(l);
  const manifest={name:"Rezepte & Einkauf (Pink Pastell)", short_name:"Rezepte", start_url:".", display:"standalone",
    background_color:"#ffeef6", theme_color:"#ff74b8",
    icons:[{src:icon192,sizes:"192x192",type:"image/png"},{src:icon512,sizes:"512x512",type:"image/png"}]};
  const blob=new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"});
  const url=URL.createObjectURL(blob); const lm=document.createElement('link'); lm.rel='manifest'; lm.href=url; document.head.appendChild(lm);
})();
</script>
</head>
<body>
<header>
  <div class="container">
    <div class="title-row">
      <div class="logo" aria-hidden="true">‚ô°</div>
      <h1>Rezepte ‚Ä¢ Produkte ‚Ä¢ Einkaufskorb</h1>
      <span class="right"></span>
    </div>
    <div class="tabs">
      <button type="button" class="tab active" data-tab="recipes" id="tab-recipes">Rezepte</button>
      <button type="button" class="tab" data-tab="products" id="tab-products">Produkte</button>
      <button type="button" class="tab" data-tab="cart" id="tab-cart">Einkaufskorb</button>
    </div>
  </div>
</header>

<main>
  <!-- Rezepte -->
  <section id="view-recipes">
    <div class="card accent recipes">
      <div class="row" style="gap:8px;">
        <div class="section-title">Rezepte</div>
        <div class="row row-2">
          <input id="search-recipes" type="search" placeholder="Rezepte oder Zutaten suchen ‚Ä¶" aria-label="Rezepte suchen">
          <div class="right" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
            <input id="import-file" type="file" accept="application/json" style="display:none">
            <button type="button" class="btn neutral" id="btn-import">Import</button>
            <button type="button" class="btn neutral" id="btn-export">Export</button>
            <button type="button" id="toggle-editor" class="btn pink">+ Neues Rezept</button>
          </div>
        </div>
        <div class="muted" style="font-size:12px;">Export/Import sichert <strong>Rezepte, Produkte, Einkaufskorb</strong> als JSON.</div>
      </div>
    </div>

    <!-- Filter nach Tags -->
    <details class="collapsible card" id="recipe-filters">
      <summary><span class="chev">‚ñ∂</span> Filter nach Tags</summary>
      <div style="padding:12px;">
        <div id="filter-chips"></div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="btn pink-ghost" id="btn-clear-filters">Filter zur√ºcksetzen</button>
        </div>
      </div>
    </details>

    <!-- Editor -->
    <details class="collapsible card" id="recipe-editor">
      <summary>
        <span class="chev">‚ñ∂</span> Rezept-Editor
        <span class="muted">(klicken zum √ñffnen/Schliessen)</span>
      </summary>
      <div style="padding: 12px 12px;">
        <div class="row row-2">
          <div><label class="muted">Titel</label><input id="r-title" type="text" placeholder="z. B. Strawberry Cheesecake"></div>
          <div><label class="muted">Link (Video/Quelle)</label><input id="r-link" type="url" placeholder="https://‚Ä¶"></div>
        </div>

        <div class="row row-2" style="margin-top:8px;">
          <div>
            <label class="muted">Foto (optional)</label>
            <input id="r-photo" type="file" accept="image/*">
            <img id="r-photo-preview" class="img-glow" style="display:none;margin-top:8px; width:100%; max-height:220px; object-fit:cover;" />
          </div>
          <div>
            <label class="muted">Anleitung</label>
            <textarea id="r-steps" placeholder="Kurz die Zubereitung ‚Ä¶"></textarea>
          </div>
        </div>

        <div class="section-title" style="margin-top:8px;">Zutaten</div>
        <div id="ingredients" class="grid"></div>
        <button type="button" class="btn pink-ghost" id="btn-add-ingredient">+ Zutat</button>

        <div class="section-title" style="margin-top:12px;">Tags</div>
        <div id="tag-pickers" class="card" style="background:#fff"></div>

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button type="button" class="btn pink" id="btn-save-recipe">Rezept speichern</button>
          <button type="button" class="btn neutral" id="btn-reset-form">Formular leeren</button>
        </div>
      </div>
    </details>

    <div id="recipe-list" class="grid"></div>
  </section>

  <!-- Produkte -->
  <section id="view-products" style="display:none;">
    <div class="card accent products">
      <div class="section-title">Produkte</div>
      <div class="row row-2">
        <input id="search-products" type="search" placeholder="Produkt suchen (z. B. Gurke, Tomate ‚Ä¶)" aria-label="Produkte suchen">
        <div class="right" style="display:flex; justify-content:flex-end">
          <button type="button" id="btn-add-product-row" class="btn pink">+ Produkt hinzuf√ºgen</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px;">Kategorien sind einklappbar ‚Ä¢ ‚Äû+ in Korb‚Äú legt direkt in den Einkaufskorb.</div>
    </div>

    <div id="product-add" class="card" style="display:none;">
      <div class="row row-2">
        <div><label class="muted">Produktname</label><input id="p-name" type="text" placeholder="z. B. Rucola"></div>
        <div><label class="muted">Kategorie</label><select id="p-cat"></select></div>
      </div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button type="button" class="btn pink" id="p-save">Produkt speichern</button>
        <button type="button" class="btn neutral" id="p-cancel">Abbrechen</button>
      </div>
    </div>

    <div id="product-list" class="grid" style="gap:8px;"></div>
  </section>

  <!-- Einkaufskorb -->
  <section id="view-cart" style="display:none;">
    <div class="card accent cart">
      <div class="section-title">Einkaufskorb</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" class="btn neutral" id="btn-check-all">Alle anhaken</button>
        <button type="button" class="btn neutral" id="btn-uncheck-all">Alle abhaken</button>
        <button type="button" class="btn orange" id="btn-clear-cart">Korb leeren</button>
      </div>
      <div class="info" style="margin-top:6px;">Menge per Feld/¬± √§ndern. ‚Äû?‚Äú zeigt, aus welchem Rezept es stammt.</div>
    </div>
    <div id="cart-list"></div>
  </section>
</main>

<script>
/* ===== Daten / Kategorien ===== */
const CATS=["Gem√ºse","Fr√ºchte","Milchprodukte","Fleisch/Fisch","Getreide/Backwaren","Konserven","Tiefk√ºhl","Gew√ºrze","Saucen/√ñle","Getr√§nke","Snacks","Sonstiges"];
const AISLE_ORDER=CATS.slice();
const TAG_CATEGORIES={
  "Mahlzeit":["Fr√ºhst√ºck","Snack","Mittagessen","Abendessen","Brunch","Dessert"],
  "Ern√§hrung":["Vegan","Veggie","Fleisch","Pescetarisch","Glutenfrei","Laktosefrei","Low Carb","Proteinreich","Gesund"],
  "K√ºche":["Italienisch","Asiatisch","Indisch","Mexikanisch","Mediterran","Schweizerisch","Orientalisch","Amerikanisch"],
  "Aufwand":["Schnell","Meal Prep","< 5 Zutaten","One-Pot","Ofen","Pfanne","Airfryer"]
};
const selectedFilters=Object.fromEntries(Object.keys(TAG_CATEGORIES).map(k=>[k,new Set()]));
const store={ load(k,f){ try{ return JSON.parse(localStorage.getItem(k)) ?? f }catch{ return f } }, save(k,v){ localStorage.setItem(k, JSON.stringify(v)) } };
let recipes=store.load('recipes',[]), cart=store.load('cart',[]), products=store.load('products',null);

/* Initial-Produktliste */
if(!products){
  const veg=["Gurke","Salat (Kopf)","R√∂mersalat","Eisbergsalat","Tomate","Cocktailtomaten","Cherry-Tomaten","Strauchtomaten","Paprika rot","Paprika gelb","Paprika gr√ºn","Peperoncini","Chili","Zwiebel gelb","Zwiebel rot","Fr√ºhlingszwiebel","Schalotte","Knoblauch","Karotte","Sellerie Stange","Sellerie Knolle","Fenchel","Lauch","Zucchini","Aubergine","Brokkoli","Blumenkohl","Rosenkohl","Spinat","Mangold","Kohlrabi","Weisskohl","Rotkohl","Wirsing","Radieschen","Rettich","Rucola","Feldsalat","Kresse","Pilze Champignons","Steinpilze","Austernpilze","Shiitake","Portobello","S√ºsskartoffel","Kartoffel festkochend","Kartoffel mehlig","K√ºrbis Hokkaido","K√ºrbis Butternut","Maiskolben","Zuckermais","Bohnen gr√ºn","Erbsen frisch","Spargel gr√ºn","Spargel weiss","Rote Bete","Topinambur","Artischocke","Okra","Pak Choi","Bok Choy","Edamame","Ingwer","Kurkuma","Zitronengras","Avocado","Oliven gr√ºn","Oliven schwarz","Kapern"];
  const fruit=["Apfel","Birne","Banane","Orange","Mandarine","Clementine","Grapefruit","Zitrone","Limette","Ananas","Mango","Papaya","Kiwi","Trauben hell","Trauben dunkel","Erdbeeren","Himbeeren","Brombeeren","Heidelbeeren","Kirschen","Pfirsich","Nektarine","Aprikose","Pflaume","Granatapfel","Melone Wassermelone","Melone Honigmelone","Melone Cantaloupe","Feigen","Datteln","Passionsfrucht","Kokosnuss"];
  const dairy=["Milch","H-Milch","Laktosefreie Milch","Rahm/Sahne","Joghurt natur","Joghurt griechisch","Skyr","Quark","Butter","Margarine","K√§se Gouda","K√§se Emmentaler","K√§se Gruy√®re","Mozzarella","Feta","Parmesan","Ricotta","Mascarpone","Frischk√§se"];
  const meatFish=["H√§hnchenbrust","Pouletgeschnetzeltes","Rindhack","Rindsgeschnetzeltes","Schweinsfilet","Speckw√ºrfel","Schinken","Salami","Lachs frisch","Lachs ger√§uchert","Thunfisch frisch","Thunfisch (Dose)","Garnelen","Tofu natur","Tofu ger√§uchert","Tempeh"];
  const grain=["Brot","Br√∂tchen","Vollkornbrot","Tortilla Wraps","Toast","Reis","Basmatireis","Jasminreis","Risotto Reis","Pasta Spaghetti","Pasta Penne","Pasta Fusilli","Couscous","Bulgur","Quinoa","Haferflocken","Mehl Weiss","Mehl Vollkorn","Backpulver","Hefe"];
  const cans=["Tomaten (Dose)","Passata","Mais (Dose)","Kidneybohnen (Dose)","Kichererbsen (Dose)","Kokosmilch (Dose)","Bohnensalat (Dose)","Oliven (Glas)","Essiggurken"];
  const frozen=["TK-Spinat","TK-Beerenmix","TK-Erbsen","TK-Pizza","TK-Pommes","TK-Gem√ºsemix","Eiscreme"];
  const spices=["Salz","Pfeffer schwarz","Paprikapulver edels√ºss","Paprikapulver scharf","Currypulver","Chiliflocken","Kreuzk√ºmmel","Zimt","Oregano","Basilikum getrocknet","Thymian","Rosmarin","Knoblauchpulver","Zwiebelpulver"];
  const sauces=["Oliven√∂l","Raps√∂l","Sonnenblumen√∂l","Sesam√∂l","Balsamico","Weissweinessig","Sojasauce","Worcestersauce","Sriracha","Mayonnaise","Senf","Ketchup","BBQ-Sauce","Pesto gr√ºn","Pesto rot","Tahini"];
  const drinks=["Wasser still","Wasser sprudel","Apfelsaft","Orangensaft","Cola","Tonic Water","Mineralwasser","Kaffee Bohnen","Kaffee gemahlen","Tee Schwarz","Tee Kr√§uter"];
  const snacks=["Chips","N√ºsse gesalzen","Erdn√ºsse","Mandeln","Schokolade dunkel","Schokolade Milch","Kekse","Reiswaffeln","Popcorn"];
  products=[
    ...veg.map(n=>({id:crypto.randomUUID(), name:n, cat:"Gem√ºse"})),
    ...fruit.map(n=>({id:crypto.randomUUID(), name:n, cat:"Fr√ºchte"})),
    ...dairy.map(n=>({id:crypto.randomUUID(), name:n, cat:"Milchprodukte"})),
    ...meatFish.map(n=>({id:crypto.randomUUID(), name:n, cat:"Fleisch/Fisch"})),
    ...grain.map(n=>({id:crypto.randomUUID(), name:n, cat:"Getreide/Backwaren"})),
    ...cans.map(n=>({id:crypto.randomUUID(), name:n, cat:"Konserven"})),
    ...frozen.map(n=>({id:crypto.randomUUID(), name:n, cat:"Tiefk√ºhl"})),
    ...spices.map(n=>({id:crypto.randomUUID(), name:n, cat:"Gew√ºrze"})),
    ...sauces.map(n=>({id:crypto.randomUUID(), name:n, cat:"Saucen/√ñle"})),
    ...drinks.map(n=>({id:crypto.randomUUID(), name:n, cat:"Getr√§nke"})),
    ...snacks.map(n=>({id:crypto.randomUUID(), name:n, cat:"Snacks"})),
  ];
  store.save('products',products);
}

/* ===== Utilities ===== */
const el=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const norm=s=>(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
function h(tag,attrs={},...children){
  const e=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==='class') e.className=v;
    else if(k==='html') e.innerHTML=v;
    else if(k.startsWith('on') && typeof v==='function') e.addEventListener(k.slice(2), v);
    else e.setAttribute(k,v);
  }
  for(const c of children.flat()){ if(c==null) continue; e.appendChild(typeof c==='string'?document.createTextNode(c):c) }
  return e;
}

/* ===== Tabs ===== */
function switchTab(tab){
  $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  el('#view-recipes').style.display=(tab==='recipes')?'block':'none';
  el('#view-products').style.display=(tab==='products')?'block':'none';
  el('#view-cart').style.display=(tab==='cart')?'block':'none';
  if(tab==='cart') renderCart();
  if(tab==='products') renderProducts();
  if(tab==='recipes') renderRecipeList();
}
el('#tab-recipes').addEventListener('click',()=>switchTab('recipes'));
el('#tab-products').addEventListener('click',()=>switchTab('products'));
el('#tab-cart').addEventListener('click',()=>switchTab('cart'));

/* ===== Einheiten-Logik ===== */
const UNIT_OPTIONS = ["", "g", "kg", "ml", "l", "stk"];
function defaultUnitForCategory(cat){
  switch(cat){
    case "Saucen/√ñle":
    case "Getr√§nke": return "ml";
    case "Fleisch/Fisch":
    case "Milchprodukte":
    case "Tiefk√ºhl":
    case "Gew√ºrze":
    case "Gem√ºse":
    case "Fr√ºchte": return "g";
    case "Getreide/Backwaren":
    case "Konserven":
    case "Snacks": return "stk";
    default: return "";
  }
}
function makeUnitSelect(val){
  const sel=h('select');
  UNIT_OPTIONS.forEach(u=>sel.appendChild(h('option',{value:u},u||'‚Äî')));
  sel.value = UNIT_OPTIONS.includes(val||"") ? (val||"") : "";
  return sel;
}

/* ===== Rezept-Editor ===== */
const editor=el('#recipe-editor');
el('#toggle-editor').addEventListener('click',(e)=>{ e.preventDefault(); editor.open=!editor.open; });

const ingredientsWrap=el('#ingredients');
const photoInput=el('#r-photo');
const photoPreview=el('#r-photo-preview');

function ingredientRow(data={}){
  const rowId = crypto.randomUUID();
  const datalistId = `dl-${rowId}`;

  const row=h('div',{class:'row',style:'align-items:end; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap:8px; border-bottom:1px dashed var(--border); padding-bottom:8px;'});

  const nameLabel=h('label',{class:'muted'},'Zutat');
  const nameInput=h('input',{type:'text', list:datalistId, placeholder:'z. B. Tomate', value:data.name||''});
  const dl=h('datalist',{id:datalistId});
  // Optionen aus Produktliste:
  Array.from(new Set(products.map(p=>p.name))).sort((a,b)=>a.localeCompare(b,'de')).forEach(n=>{
    dl.appendChild(h('option',{value:n}));
  });

  const qtyLabel=h('label',{class:'muted'},'Menge');
  const qtyInput=h('input',{type:'number', step:'any', inputmode:'decimal', placeholder:'z. B. 200', value:data.amount||''});

  const unitLabel=h('label',{class:'muted'},'Einheit');
  const unitSel=makeUnitSelect(data.unit||'');

  const catLabel=h('label',{class:'muted'},'Kategorie');
  const catSel=h('select');
  CATS.forEach(c=>catSel.appendChild(h('option',{value:c},c)));
  catSel.value=data.cat||'Sonstiges';

  const optWrap=h('label',{class:'muted',style:'display:flex;align-items:center;gap:6px;'},
    h('input',{type:'checkbox',checked:!!data.optional}), ' add-on'
  );

  const del=h('button',{type:'button',class:'btn neutral small',onclick:()=>row.remove()},'‚úï');

  // Auto-Kategorie & Einheit setzen, wenn Produktname exakt matcht
  function applyGuessFromProduct(name){
    const prod = products.find(p=>norm(p.name)===norm(name));
    if(prod){
      catSel.value = prod.cat;
      if(!unitSel.value){ unitSel.value = defaultUnitForCategory(prod.cat); }
    }
  }
  nameInput.addEventListener('change',()=>applyGuessFromProduct(nameInput.value));
  nameInput.addEventListener('input',()=>{
    // Wenn exakter Treffer in Vorschl√§gen (z. B. durch iOS Auswahl), guessen:
    applyGuessFromProduct(nameInput.value);
  });

  // Defaults falls schon Kategorie gesetzt wurde
  if(!data.unit && data.cat) unitSel.value = defaultUnitForCategory(data.cat);

  // Layout einf√ºgen
  const nameBox=h('div',{}, nameLabel, nameInput, dl);
  const qtyBox=h('div',{}, qtyLabel, qtyInput);
  const unitBox=h('div',{}, unitLabel, unitSel);
  const catBox=h('div',{}, catLabel, catSel);
  const optBox=h('div',{}, optWrap);
  const actionsBox=h('div',{}, del);

  row.append(nameBox, qtyBox, unitBox, catBox, optBox, actionsBox);
  return row;
}

el('#btn-add-ingredient').addEventListener('click',()=>ingredientsWrap.appendChild(ingredientRow()));

photoInput.addEventListener('change',e=>{
  const f=e.target.files&&e.target.files[0]; if(!f){ photoPreview.style.display='none'; return; }
  const r=new FileReader(); r.onload=()=>{ photoPreview.src=r.result; photoPreview.style.display='block' }; r.readAsDataURL(f);
});
function resetForm(){
  el('#r-title').value=''; el('#r-link').value=''; el('#r-steps').value='';
  ingredientsWrap.innerHTML=''; photoInput.value=''; photoPreview.style.display='none';
  renderTagPickers(null);
}
el('#btn-reset-form').addEventListener('click',resetForm);

el('#btn-save-recipe').addEventListener('click',()=>{
  const title=el('#r-title').value.trim(); if(!title){ alert('Bitte Titel eingeben'); return; }
  const link =el('#r-link').value.trim();
  const steps=el('#r-steps').value.trim();
  const img  =photoPreview.style.display==='block'?photoPreview.src:null;

  const rows=Array.from(ingredientsWrap.children);
  if(rows.length===0){ alert('Bitte mindestens eine Zutat hinzuf√ºgen'); return; }

  const ings = rows.map(row=>{
    const [nameIn, qtyIn, unitSel, catSel, optWrap] = row.querySelectorAll('input, select');
    const name = nameIn.value.trim();
    const amount = qtyIn.value ? String(qtyIn.value).trim() : '';
    const unit = unitSel.value;
    const cat = catSel.value;
    const optional = optWrap.checked; // default false
    const qty = amount ? (unit ? `${amount} ${unit}` : amount) : '';
    return { name, qty, cat, optional, amount, unit };
  }).filter(x=>x.name);

  const tags=collectSelectedTagsFromEditor();
  const recipe={ id:crypto.randomUUID(), title, link, steps, img, ings, tags };
  recipes.unshift(recipe); store.save('recipes',recipes);
  resetForm(); editor.open=false; renderRecipeList(); alert('Rezept gespeichert');
});

/* ===== Tags ===== */
function renderTagPickers(existing=null){
  const wrap=document.getElementById('tag-pickers'); wrap.innerHTML='';
  for(const [cat,tags] of Object.entries(TAG_CATEGORIES)){
    const box=h('div',{class:'tag-group'}); const h4=h('h4',{},cat); const chips=h('div',{class:'chips'});
    tags.forEach(t=>{
      const chip=h('button',{type:'button',class:'chip'},t);
      const isOn=!!(existing && existing[cat] && existing[cat].includes(t));
      if(isOn) chip.classList.add('active');
      chip.addEventListener('click',()=>chip.classList.toggle('active'));
      chips.appendChild(chip);
    });
    box.append(h4,chips); wrap.appendChild(box);
  }
}
function collectSelectedTagsFromEditor(){
  const result={}; const groups=document.querySelectorAll('#tag-pickers .tag-group');
  groups.forEach(g=>{ const cat=g.querySelector('h4').textContent;
    const active=Array.from(g.querySelectorAll('.chip.active')).map(c=>c.textContent);
    if(active.length) result[cat]=active;
  }); return result;
}

/* Filter */
function renderFilterChips(){
  const host=document.getElementById('filter-chips'); host.innerHTML='';
  for(const [cat,tags] of Object.entries(TAG_CATEGORIES)){
    const box=h('div',{class:'tag-group'}); const h4=h('h4',{},cat); const chips=h('div',{class:'chips'});
    tags.forEach(t=>{
      const chip=h('button',{type:'button',class:'chip small'},t);
      if(selectedFilters[cat].has(t)) chip.classList.add('active');
      chip.addEventListener('click',()=>{
        if(selectedFilters[cat].has(t)) selectedFilters[cat].delete(t); else selectedFilters[cat].add(t);
        chip.classList.toggle('active'); renderRecipeList();
      });
      chips.appendChild(chip);
    });
    box.append(h4,chips); host.append(box);
  }
}
document.getElementById('btn-clear-filters').addEventListener('click',()=>{
  for(const k of Object.keys(selectedFilters)) selectedFilters[k].clear();
  renderFilterChips(); renderRecipeList();
});

/* Rezepte anzeigen */
const recipeList=el('#recipe-list'); const searchRecipes=el('#search-recipes');
function matchRecipe(r,q){
  if(q){ const s=norm(q); if(!(norm(r.title).includes(s) || (r.ings&&r.ings.some(i=>norm(i.name).includes(s))))) return false; }
  for(const [cat,set] of Object.entries(selectedFilters)){
    if(set.size===0) continue; const rList=(r.tags&&r.tags[cat])?new Set(r.tags[cat]):new Set();
    if(!Array.from(set).some(x=>rList.has(x))) return false;
  }
  return true;
}
function recipeCard(r){
  const card=h('div',{class:'card'});
  if(r.img) card.appendChild(h('img',{src:r.img,class:'img-glow',style:'width:100%; max-height:220px; object-fit:cover; margin-bottom:8px'}));
  card.append(
    h('div',{class:'row'}, h('div',{class:'section-title'},r.title), r.link?h('a',{href:r.link,target:'_blank',class:'muted'},'Link √∂ffnen ‚Üó'):h('span',{class:'muted'},'')),
    h('div',{}, h('h3',{},'Zutaten'),
      ...r.ings.filter(i=>!i.optional).map(i=>h('div',{class:'checkline'},`‚Ä¢ ${i.name}`,i.qty?` ‚Äî ${i.qty}`:'',' ',h('span',{class:'pill'},i.cat))),
      r.ings.some(i=>i.optional)?h('div',{},...r.ings.filter(i=>i.optional).map(i=>h('span',{class:'pill',style:'margin-right:6px;'},i.name+' ‚Ä¢ add-on'))):null
    ),
    r.steps?h('div',{},h('h3',{},'Anleitung'),h('div',{},r.steps)):null
  );
  if(r.tags && Object.keys(r.tags).length){
    const tagWrap=h('div',{class:'tags-inline'});
    for(const [cat,list] of Object.entries(r.tags)){ list.forEach(t=>tagWrap.appendChild(h('span',{class:'chip small active'},`${cat}: ${t}`))); }
    card.appendChild(tagWrap);
  }
  card.appendChild(
    h('div',{style:'display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;'},
      h('button',{type:'button',class:'btn pink',onclick:()=>openAddDialog(r.id)},'Zum Einkaufskorb'),
      h('button',{type:'button',class:'btn pink-ghost',onclick:()=>editRecipe(r.id)},'Bearbeiten'),
      h('button',{type:'button',class:'btn neutral',onclick:()=>deleteRecipe(r.id)},'L√∂schen')
    )
  );
  return card;
}
function renderRecipeList(){
  const q=searchRecipes.value; recipeList.innerHTML='';
  const list=recipes.filter(r=>matchRecipe(r,q));
  if(!list.length){ recipeList.appendChild(h('div',{class:'muted'},q?'Keine Treffer.':'Noch keine Rezepte.')); return; }
  list.forEach(r=>recipeList.appendChild(recipeCard(r)));
}
searchRecipes.addEventListener('input',renderRecipeList);
function deleteRecipe(id){ if(!confirm('Rezept wirklich l√∂schen?')) return; recipes=recipes.filter(r=>r.id!==id); store.save('recipes',recipes); renderRecipeList(); }
function editRecipe(id){
  const r=recipes.find(x=>x.id===id); if(!r) return; editor.open=true; resetForm();
  el('#r-title').value=r.title; el('#r-link').value=r.link||''; el('#r-steps').value=r.steps||'';
  if(r.img){ photoPreview.src=r.img; photoPreview.style.display='block' }
  // Zutaten wieder in Felder splitten (Menge/Einheit)
  r.ings.forEach(i=>{
    const q=parseQty(i.qty||''); ingredientsWrap.appendChild(ingredientRow({name:i.name, amount:q.value ?? '', unit:q.unit ?? '', cat:i.cat, optional:!!i.optional}));
  });
  renderTagPickers(r.tags||null); window.scrollTo({top:0,behavior:'smooth'});
}

/* ===== Add-to-Cart + Add-ons via Modal ===== */
function openAddDialog(recipeId){
  const r=recipes.find(x=>x.id===recipeId); if(!r) return;

  const base = r.ings.filter(i=>!i.optional);
  const opts = r.ings.filter(i=>i.optional);

  const overlay = h('div',{class:'modal-backdrop', onclick:(ev)=>{ if(ev.target===overlay) overlay.remove(); }});
  const modal = h('div',{class:'modal'});
  modal.appendChild(h('h3',{},'Zum Einkaufskorb hinzuf√ºgen'));
  modal.appendChild(h('div',{class:'muted'},`Rezept: ${r.title}`));

  const list = h('div',{class:'list'});
  if(opts.length){
    list.appendChild(h('div',{class:'section-title'},'Optionale Add-ons (H√§kchen setzen)'));
    opts.forEach(opt=>{
      const id = crypto.randomUUID();
      const line = h('label',{class:'checkline', for:id, style:'border:0; padding:6px 0;'},
        h('input',{id, type:'checkbox'}),' ',
        h('span',{},opt.name),
        opt.qty? h('span',{class:'muted'},` ‚Äî ${opt.qty}`): null,
        h('span',{class:'right'}), h('span',{class:'pill'},opt.cat)
      );
      list.appendChild(line);
    });
  } else {
    list.appendChild(h('div',{class:'muted'},'Keine optionalen Zutaten vorhanden.'));
  }

  modal.appendChild(list);
  const actions = h('div',{class:'actions'},
    h('button',{type:'button',class:'btn neutral',onclick:()=>overlay.remove()},'Abbrechen'),
    h('button',{type:'button',class:'btn pink',onclick:()=>{
      const chosenNames = Array.from(list.querySelectorAll('input[type="checkbox"]'))
        .map((cb,i)=>({on:cb.checked, idx:i}))
        .filter(x=>x.on).map(x=>opts[x.idx].name.toLowerCase());
      const selected = [];
      base.forEach(i=>selected.push({...i, addon:false}));
      opts.filter(i=>chosenNames.includes(i.name.toLowerCase())).forEach(i=>selected.push({...i, addon:true}));
      addToCart(selected, r);
      overlay.remove();
      switchTab('cart');
    }},'In den Korb')
  );
  modal.appendChild(actions);
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

/* Mengen-Helpers */
function parseQty(str){
  if(!str) return {value:null,unit:null,raw:''};
  const s=str.replace(',', '.').trim();
  const m=s.match(/^(\d+(\.\d+)?)\s*([a-zA-Z√§√∂√º√Ñ√ñ√ú]+)?/);
  if(!m) return {value:null,unit:null,raw:str};
  const val=parseFloat(m[1]); const unitRaw=(m[3]||'').toLowerCase(); let unit=null;
  if(['g','gram','gramm'].includes(unitRaw)) unit='g';
  else if(['stk','st√ºck','stueck','pcs'].includes(unitRaw)) unit='stk';
  else if(['kg'].includes(unitRaw)) unit='kg';
  else if(['ml'].includes(unitRaw)) unit='ml';
  else if(['l','lt','liter'].includes(unitRaw)) unit='l';
  return {value:isNaN(val)?null:val, unit, raw:str};
}
function formatQty(v,unit){
  if(v==null) return '';
  if(unit==='g') return `${Math.round(v)} g`;
  if(unit==='kg') return `${(+v).toFixed(2)} kg`;
  if(unit==='stk') return `${Math.round(v)} Stk`;
  if(unit==='ml') return `${Math.round(v)} ml`;
  if(unit==='l')  return `${(+v).toFixed(2)} l`;
  return String(v);
}
function stepFor(q){ if(q.unit==='stk') return 1; if(q.unit==='g') return (q.value!=null && q.value>=100)?100:10; if(q.unit==='kg'||q.unit==='l') return 0.1; if(q.unit==='ml') return 50; return 1; }

/* Cart + Quellen */
function addToCart(items,recipe=null){
  for(const it of items){
    const existing=cart.find(x=>norm(x.name)===norm(it.name) && x.cat===it.cat);
    const source=recipe?{title:recipe.title, qty:it.qty||''}:{title:'Manuell', qty:it.qty||''};
    if(existing){
      const ex=parseQty(existing.qty||''); const ne=parseQty(it.qty||'');
      if(ex.unit&&ne.unit&&ex.unit===ne.unit&&ex.value!=null&&ne.value!=null){ existing.qty=formatQty(ex.value+ne.value,ex.unit); }
      else if(it.qty && (!existing.qty || !existing.qty.toLowerCase().includes(it.qty.toLowerCase()))){ existing.qty=existing.qty?`${existing.qty} + ${it.qty}`:it.qty; }
      existing.addon=existing.addon||!!it.addon; (existing.sources=existing.sources||[]).push(source);
    }else{
      cart.push({ id:crypto.randomUUID(), name:it.name, qty:it.qty||'', cat:it.cat, addon:!!it.addon, checked:false, sources:[source] });
    }
  }
  store.save('cart',cart); renderCart();
}

/* Produkte (collapsible, fallback) */
const productList=el('#product-list'); const searchProducts=el('#search-products');
const addRowBtn=el('#btn-add-product-row'); const addBox=el('#product-add');
const pName=el('#p-name'); const pCat=el('#p-cat'); const pSave=el('#p-save'); const pCancel=el('#p-cancel');
CATS.forEach(c=>pCat.appendChild(h('option',{value:c},c)));
addRowBtn.addEventListener('click',()=>{ addBox.style.display=addBox.style.display==='none'?'block':'none'; if(addBox.style.display==='block') pName.focus(); });
pCancel.addEventListener('click',()=>{ addBox.style.display='none'; pName.value=''; pCat.value='Gem√ºse'; });
pSave.addEventListener('click',()=>{
  const name=pName.value.trim(); if(!name){ alert('Bitte Produktname eingeben'); return; }
  const cat=pCat.value; const exists=products.some(p=>norm(p.name)===norm(name)&&p.cat===cat);
  if(exists){ alert('Produkt existiert bereits in dieser Kategorie'); return; }
  products.unshift({id:crypto.randomUUID(), name, cat}); store.save('products',products);
  pName.value=''; pCat.value='Gem√ºse'; addBox.style.display='none'; renderProducts();
});
function renderProducts(){
  const q=norm(searchProducts.value); productList.innerHTML='';
  function productLine(it){
    const line=h('div',{class:'checkline',style:'padding-left:6px;'});
    line.append(h('div',{},it.name), h('span',{class:'pill'},it.cat), h('span',{class:'right'}),
      h('button',{type:'button',class:'btn pink small',onclick:()=>addToCart([{name:it.name, qty:'', cat:it.cat, addon:false}])},'+ in Korb'));
    return line;
  }
  function section(cat,items){
    if(!items.length) return;
    if(SUPPORTS_DETAILS){
      const sec=h('details',{class:'collapsible card',open:false});
      const sum=h('summary',{role:'button','aria-expanded':'false'},h('span',{class:'chev'},'‚ñ∂'),' ',h('strong',{},cat),' ',h('span',{class:'muted'},`(${items.length})`));
      sec.appendChild(sum); items.forEach(it=>sec.appendChild(productLine(it)));
      sec.addEventListener('toggle',()=>sum.setAttribute('aria-expanded',sec.open?'true':'false'));
      productList.appendChild(sec);
    }else{
      const sec=h('div',{class:'card',style:'padding:10px'});
      const header=h('div',{class:'checkline',style:'cursor:pointer; user-select:none;'},h('strong',{},cat),' ',h('span',{class:'muted'},`(${items.length})`),h('span',{class:'right'}),h('span',{},'‚ñ∏'));
      const content=h('div',{style:'display:none; margin-top:6px;'}); items.forEach(it=>content.appendChild(productLine(it)));
      header.addEventListener('click',()=>{ const open=content.style.display!=='none'; content.style.display=open?'none':'block'; header.lastChild.textContent=open?'‚ñ∏':'‚ñæ'; });
      sec.append(header,content); productList.appendChild(sec);
    }
  }
  for(const cat of AISLE_ORDER){ const items=products.filter(p=>p.cat===cat && (!q || norm(p.name).includes(q) || norm(cat).includes(q))); section(cat,items); }
  if(!productList.children.length) productList.appendChild(h('div',{class:'card'},h('div',{class:'muted'},'Keine Produkte gefunden.')));
}
searchProducts.addEventListener('input',renderProducts);

/* Einkaufskorb */
const cartList=el('#cart-list');
el('#btn-clear-cart').addEventListener('click',()=>{ if(!confirm('Einkaufskorb wirklich leeren?')) return; cart=[]; store.save('cart',cart); renderCart(); });
el('#btn-uncheck-all').addEventListener('click',()=>{ cart.forEach(i=>i.checked=false); store.save('cart',cart); renderCart(); });
el('#btn-check-all').addEventListener('click',()=>{ cart.forEach(i=>i.checked=true); store.save('cart',cart); renderCart(); });

function renderCart(){
  cartList.innerHTML=''; if(!cart.length){ cartList.appendChild(h('div',{class:'card'},h('div',{class:'muted'},'Dein Einkaufskorb ist leer.'))); return; }
  for(const cat of AISLE_ORDER){
    const items=cart.filter(i=>i.cat===cat); if(!items.length) continue;
    const sec=h('div',{class:'card',style:'padding:10px'}); sec.appendChild(h('div',{class:'section-title',style:'margin-bottom:4px;'},cat));
    items.forEach(it=>{
      const line=h('div',{class:'checkline'});
      const cb=h('input',{type:'checkbox',checked:it.checked,onchange:()=>{ it.checked=cb.checked; store.save('cart',cart); }});
      const qtyInput=h('input',{type:'text',value:it.qty||'', 'aria-label':'Menge bearbeiten'});
      qtyInput.addEventListener('change',()=>{ it.qty=qtyInput.value; store.save('cart',cart); });
      const minus=h('button',{type:'button',class:'btn neutral icon small',onclick:()=>{ const q=parseQty(qtyInput.value||it.qty||''); if(q.value==null) return; const step=stepFor(q); const newVal=Math.max(0,q.value-step); qtyInput.value=formatQty(newVal,q.unit)||String(newVal); it.qty=qtyInput.value; store.save('cart',cart);} },'‚Äì');
      const plus =h('button',{type:'button',class:'btn neutral icon small',onclick:()=>{ const q=parseQty(qtyInput.value||it.qty||''); if(q.value==null) return; const step=stepFor(q); const newVal=q.value+step; qtyInput.value=formatQty(newVal,q.unit)||String(newVal); it.qty=qtyInput.value; store.save('cart',cart);} },'+');
      const infoBtn=h('button',{type:'button',title:'Herkunft anzeigen',class:'btn neutral icon small',onclick:()=>{ const list=(it.sources||[]).map(s=>`‚Ä¢ ${s.qty?`${s.qty} ‚Äì `:''}${s.title}`).join('\n'); alert(`Zutat: ${it.name}\nKategorie: ${it.cat}\nGesamt: ${it.qty||'‚Äì'}${it.addon?' (add-on)':''}\n\nHerkunft:\n${list||'‚Äî'}`); }},'?');
      const del=h('button',{type:'button',class:'btn neutral small',onclick:()=>{ cart=cart.filter(x=>x.id!==it.id); store.save('cart',cart); renderCart(); }},'L√∂schen');
      const left=h('div',{}, h('div',{},`${it.name}${it.addon?' ‚Ä¢ add-on':''}`), h('div',{class:'info'}, it.sources&&it.sources.length?`aus ${Array.from(new Set(it.sources.map(s=>s.title))).join(', ')}`:'manuell'));
      const qtyWrap=h('div',{class:'qty'},minus,qtyInput,plus);
      line.append(cb,left,h('span',{class:'right'}),qtyWrap,infoBtn,del); sec.appendChild(line);
    });
    cartList.appendChild(sec);
  }
}

/* Import / Export */
function exportAll(){
  const data={version:2, exportedAt:new Date().toISOString(), recipes, products, cart};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`rezepte_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href),3000);
}
function importAllFromFile(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(!data || typeof data!=='object') throw new Error('Ung√ºltige Datei');
      if(!Array.isArray(data.recipes) || !Array.isArray(data.products) || !Array.isArray(data.cart)) throw new Error('Felder fehlen');
      if(!confirm('Bestehende Daten durch Import ersetzen?')) return;
      recipes=data.recipes; products=data.products; cart=data.cart;
      store.save('recipes',recipes); store.save('products',products); store.save('cart',cart);
      renderRecipeList(); renderProducts(); renderCart();
      alert('Import erfolgreich üéâ');
    }catch(e){ alert('Konnte nicht importieren: '+e.message); }
    finally{ el('#import-file').value=''; }
  };
  r.readAsText(file);
}
el('#btn-export').addEventListener('click',exportAll);
el('#btn-import').addEventListener('click',()=>el('#import-file').click());
el('#import-file').addEventListener('change',e=>{
  const f=e.target.files && e.target.files[0]; if(!f) return; importAllFromFile(f);
});

/* ===== Init ===== */
function init(){
  switchTab('recipes'); renderRecipeList(); renderProducts(); renderCart(); renderTagPickers(null); renderFilterChips();
  $$('button').forEach(b=>{ if(!b.hasAttribute('type')) b.setAttribute('type','button'); });
  // 1 Start-Zutatenzeile:
  ingredientsWrap.appendChild(ingredientRow());
}
init();
</script>
</body>
</html>
